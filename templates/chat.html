<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>wow</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <h2>goofball</h2>
  <div id="user-list"></div>
  <div id="chat"></div>
  <input id="message" autocomplete="off" placeholder="Say something..." />
  <button onclick="sendMessage()">Send</button>

  <script>
    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }
    function getCookie(name) {
      let nameEQ = name + "=";
      let ca = document.cookie.split(';');
      for(let i=0;i < ca.length;i++) {
        let c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
      }
      return null;
    }

    let username = "{{ username|safe }}";
    if (!username) {
      username = prompt("Enter your chat username:");
      if (!username) username = "Anonymous";
      setCookie('username', username, 30);
      location.reload();
    }

    const socket = io();

    socket.on('connect', function() {
      socket.emit('set_username', username);
    });

    socket.on('message', function(msg) {
      const chat = document.getElementById('chat');
      const messageEl = document.createElement('div');
      messageEl.textContent = msg;
      chat.appendChild(messageEl);
      chat.scrollTop = chat.scrollHeight;
    });

    socket.on('user_list', function(users) {
      const userList = document.getElementById('user-list');
      userList.textContent = "Online: " + users.join(', ');
    });

    function sendMessage() {
      const input = document.getElementById('message');
      const msg = input.value;
      if (msg.trim()) {
        socket.send(msg);
        input.value = '';
      }
    }
  </script>
</body>
</html>